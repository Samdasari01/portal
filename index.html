<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Portal - Keyyards</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-light: #f7fafc;
            --text-light: #4a5568;
            --border-light: #e2e8f0;
            --card-bg-light: #ffffff;

            --bg-dark: #1a202c;
            --text-dark: #a0aec0;
            --border-dark: #4a5568;
            --card-bg-dark: #2d3748;
        }
        html.dark {
            color-scheme: dark;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
        }
        .dark body {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .sidebar-link.active {
            background-color: #ebf8ff;
            color: #2b6cb0;
            font-weight: 600;
        }
        .dark .sidebar-link.active {
            background-color: #2b6cb0;
            color: #ffffff;
        }

        .sidebar-link:not(.active):hover {
            background-color: #edf2f7;
        }
        .dark .sidebar-link:not(.active):hover {
            background-color: #4a5568;
        }

        .btn-primary {
            background-color: #2b6cb0;
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #2c5282;
        }
        .btn-primary:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }

        .btn-danger {
            background-color: #e53e3e;
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-danger:hover {
            background-color: #c53030;
        }

        /* Table Styles */
        .task-table {
            border-collapse: collapse;
            width: 100%;
        }
        .task-table th, .task-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }
        .dark .task-table th, .dark .task-table td {
            border-bottom-color: var(--border-dark);
        }
        .task-table th {
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #718096;
        }
        .dark .task-table th {
            color: #a0aec0;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .status-badge-completed { background-color: #38a169; color: #ffffff; }
        .status-badge-in-progress { background-color: #3182ce; color: #ffffff; }
        .status-badge-to-do { background-color: #dd6b20; color: #ffffff; }
        .status-badge-blocked { background-color: #e53e3e; color: #ffffff; }
    </style>
</head>
<body>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-5 right-5 z-50 space-y-3 w-72"></div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gray-200 dark:bg-gray-900">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <div class="text-center">
                 <img src="https://image2url.com/images/1757268127491-4d7772ef-00dc-44ee-9d6c-b145a09092e6.png" alt="Keyyards Logo" class="w-24 h-24 mx-auto mb-4 rounded-full">
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Task Manager</h1>
                <p class="mt-2 text-gray-500 dark:text-gray-400">Sign in to the Keyyards workspace</p>
            </div>
            <form id="loginForm" class="mt-8 space-y-6">
                 <div class="space-y-4">
                    <div>
                        <label for="teamId" class="text-sm font-medium text-gray-700 dark:text-gray-300">Team ID</label>
                        <input id="teamId" name="teamId" type="text" required class="mt-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" placeholder="Enter your team ID">
                    </div>
                    <div>
                         <label for="username" class="text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                        <input id="username" name="username" type="text" required class="mt-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" placeholder="Enter your username">
                    </div>
                    <div>
                         <label for="password" class="text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                        <input id="password" name="password" type="password" required class="mt-1 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3" placeholder="••••••••">
                    </div>
                </div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 text-sm font-medium rounded-lg btn-primary">
                    Sign in
                </button>
                <p id="loginMessage" class="text-center text-sm text-red-500 h-4"></p>
            </form>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div id="dashboardContainer" class="hidden">
        <div class="flex h-screen bg-gray-100 dark:bg-gray-900">
            <!-- Sidebar -->
            <div class="hidden md:flex flex-col w-64 bg-white dark:bg-gray-800 border-r dark:border-gray-700">
                <div class="flex items-center justify-center h-16 border-b dark:border-gray-700">
                    <div class="flex items-center space-x-2">
                        <img src="https://image2url.com/images/1757268127491-4d7772ef-00dc-44ee-9d6c-b145a09092e6.png" alt="Keyyards Logo" class="w-10 h-10 rounded-md">
                        <h1 class="text-xl font-bold text-gray-800 dark:text-white">Keyyards</h1>
                    </div>
                </div>
                <div class="flex flex-col flex-grow p-2">
                    <nav class="flex flex-col flex-grow space-y-1" id="sidebarNav">
                        <a href="#" id="allItemsBtn" class="sidebar-link flex items-center px-4 py-2 rounded-md text-gray-700 dark:text-gray-300">
                            <i class="fas fa-th-large mr-3 w-5 text-center"></i> All Items
                        </a>
                        <a href="#" id="myItemsBtn" class="sidebar-link flex items-center px-4 py-2 rounded-md text-gray-700 dark:text-gray-300">
                            <i class="fas fa-user-check mr-3 w-5 text-center"></i> My Items
                        </a>
                        <p class="px-4 pt-4 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</p>
                        <a href="#" id="myTasksBtn" class="sidebar-link flex items-center px-4 py-2 rounded-md text-gray-700 dark:text-gray-300">
                             <i class="fas fa-tasks mr-3 w-5 text-center"></i> My Tasks
                        </a>
                        <a href="#" id="reportIssueBtn" class="flex items-center px-4 py-2 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                             <i class="fas fa-bug mr-3 w-5 text-center"></i> Report an Issue
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main content -->
            <div class="flex flex-col flex-grow">
                <header class="flex items-center justify-between h-16 px-6 bg-white dark:bg-gray-800 border-b dark:border-gray-700">
                     <div id="createNewTaskBtnContainer" class="flex items-center">
                        <button id="createNewTaskBtn" class="px-4 py-2 font-semibold rounded-md btn-primary">
                            <i class="fas fa-plus mr-2"></i> Create New
                        </button>
                    </div>
                    <div class="flex items-center">
                        <button id="themeToggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 mr-4">
                            <i class="fas fa-sun text-yellow-400 hidden"></i>
                            <i class="fas fa-moon text-gray-300"></i>
                        </button>
                        <div class="relative">
                            <button class="flex items-center space-x-2">
                                <span class="font-semibold text-gray-700 dark:text-gray-200" id="userNameDisplay"></span>
                                <i class="fas fa-user-circle text-2xl text-gray-600 dark:text-gray-400"></i>
                            </button>
                        </div>
                         <button id="logoutBtn" class="ml-4 font-bold py-2 px-4 rounded-lg btn-danger">Logout</button>
                    </div>
                </header>

                <main class="flex-grow p-6 overflow-auto">
                    <div class="w-full bg-white dark:bg-gray-800 rounded-lg shadow-md">
                        <div class="px-6 py-4 border-b dark:border-gray-700">
                             <div class="flex items-center justify-between">
                                <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Tasks</h2>
                                <div class="relative">
                                    <input type="text" class="w-64 pl-10 pr-4 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" placeholder="Search tasks...">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <table class="task-table w-full">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Assigned To</th>
                                    </tr>
                                </thead>
                                <tbody id="taskTableBody">
                                    <!-- Task rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="w-full max-w-2xl p-8 rounded-2xl space-y-6 bg-white dark:bg-gray-800 transform transition-all scale-95 opacity-0" id="createTaskModalContent">
            <div class="flex items-center justify-between pb-4 border-b dark:border-gray-700">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Create New Task</h2>
                <button id="closeCreateModalBtn" class="text-2xl text-gray-500 hover:text-gray-800 dark:hover:text-white">&times;</button>
            </div>
            <form id="createTaskForm" class="space-y-4 pt-4">
                 <input id="taskTitle" type="text" placeholder="Task Title" required class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                 <textarea id="taskDescription" placeholder="Description" required class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                 <select id="assignedTo" required class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                     <option value="" disabled selected>Assign To</option>
                 </select>
                 <select id="taskPriority" required class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                     <option>Low</option>
                     <option>Medium</option>
                     <option>High</option>
                     <option>Critical</option>
                 </select>
                 <input id="taskDueDate" type="date" required class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                 <button type="submit" class="w-full py-3 font-semibold rounded-md btn-primary">Add Task</button>
             </form>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div id="taskModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="w-full max-w-2xl p-8 rounded-2xl space-y-6 transform transition-all scale-95 opacity-0 bg-white dark:bg-gray-800" id="taskModalContent">
            <div class="flex items-center justify-between pb-4 border-b dark:border-gray-700">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 dark:text-white">Task Title</h2>
                <button id="closeModalBtn" class="text-2xl text-gray-500 hover:text-gray-800 dark:hover:text-white">&times;</button>
            </div>
            <div class="pt-4 space-y-4">
                <p id="modalDescription" class="text-gray-600 dark:text-gray-300"></p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                    <div><strong>Assigned To:</strong> <span id="modalAssignedTo"></span></div>
                    <div><strong>Due Date:</strong> <span id="modalDueDate"></span></div>
                    <div><strong>Priority:</strong> <span id="modalPriority" class="font-medium px-2 py-1 rounded-full text-xs text-white"></span></div>
                </div>
                <form id="updateTaskForm" class="flex items-end space-x-4 pt-4">
                    <div class="flex-grow">
                        <label for="modalStatus" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Update Status</label>
                        <select id="modalStatus" class="w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option>To Do</option>
                            <option>In Progress</option>
                            <option>Completed</option>
                            <option>Blocked</option>
                        </select>
                    </div>
                    <button type="submit" class="px-5 py-3 font-semibold rounded-md btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Issue Reporter Modal -->
    <div id="issueModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="w-full max-w-lg p-8 rounded-2xl space-y-6 bg-white dark:bg-gray-800 transform transition-all scale-95 opacity-0" id="issueModalContent">
            <div class="flex items-center justify-between pb-4 border-b dark:border-gray-700">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Report an Issue</h2>
                <button id="closeIssueModalBtn" class="text-2xl text-gray-500 hover:text-gray-800 dark:hover:text-white">&times;</button>
            </div>
            <div class="space-y-4 pt-4">
                <p>Encountering a problem? Please don't hesitate to reach out.</p>
                <p>To get the quickest support, please contact the developer team directly with a description of the issue you are facing.</p>
                <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <p class="font-semibold text-gray-800 dark:text-white">Contact: <a href="mailto:dev-support@keyyards.in" class="font-normal text-blue-600 hover:underline">dev-support@keyyards.in</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Theme Warning Modal -->
    <div id="themeWarningModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="w-full max-w-md p-6 rounded-lg bg-white dark:bg-gray-800 transform transition-all scale-95 opacity-0" id="themeWarningModalContent">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Switch to Light Theme?</h2>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Please be aware that switching to light theme may affect the color contrast and readability of some text elements.</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelThemeChangeBtn" class="px-4 py-2 text-sm font-medium bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">No, Cancel</button>
                <button id="confirmThemeChangeBtn" class="px-4 py-2 text-sm font-medium rounded-md btn-primary">Yes, Proceed</button>
            </div>
        </div>
    </div>


    <!-- Supabase Configuration and App Logic -->
    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';

        const SUPABASE_URL = 'https://hgmmivztqwgdzcobiulu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnbW1pdnp0cXdnZHpjb2JpdWx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNTM4MDYsImV4cCI6MjA3MjgyOTgwNn0.MS1BatLDBGL8scF7bK9so37D_84oAnU5o5HkS3sdILU';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // UI element references
        const loginScreen = document.getElementById('loginScreen');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginMessage = document.getElementById('loginMessage');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const taskTableBody = document.getElementById('taskTableBody');
        const taskModal = document.getElementById('taskModal');
        const taskModalContent = document.getElementById('taskModalContent');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const updateTaskForm = document.getElementById('updateTaskForm');
        const createNewTaskBtn = document.getElementById('createNewTaskBtn');
        const createNewTaskBtnContainer = document.getElementById('createNewTaskBtnContainer');
        const createTaskModal = document.getElementById('createTaskModal');
        const createTaskModalContent = document.getElementById('createTaskModalContent');
        const closeCreateModalBtn = document.getElementById('closeCreateModalBtn');
        const createTaskForm = document.getElementById('createTaskForm');
        const assignedToSelect = document.getElementById('assignedTo');
        const allItemsBtn = document.getElementById('allItemsBtn');
        const myItemsBtn = document.getElementById('myItemsBtn');
        const myTasksBtn = document.getElementById('myTasksBtn');
        const reportIssueBtn = document.getElementById('reportIssueBtn');
        const issueModal = document.getElementById('issueModal');
        const issueModalContent = document.getElementById('issueModalContent');
        const closeIssueModalBtn = document.getElementById('closeIssueModalBtn');
        const themeToggle = document.getElementById('themeToggle');
        const themeSunIcon = themeToggle.querySelector('.fa-sun');
        const themeMoonIcon = themeToggle.querySelector('.fa-moon');
        const themeWarningModal = document.getElementById('themeWarningModal');
        const themeWarningModalContent = document.getElementById('themeWarningModalContent');
        const confirmThemeChangeBtn = document.getElementById('confirmThemeChangeBtn');
        const cancelThemeChangeBtn = document.getElementById('cancelThemeChangeBtn');

        let session = {
            teamId: null,
            teamName: null,
            userId: null,
            userName: null,
            role: null,
        };
        
        let currentView = 'all'; // 'all' or 'my'

        // --- Core Application Logic ---
        const showToast = (message, type = 'info') => {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-xl shadow-lg text-white transform transition-all duration-300 translate-x-full opacity-0 flex items-center space-x-2`;
            let bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            let icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-info-circle"></i>';
            toast.classList.add(bgColor);
            toast.innerHTML = `${icon}<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.replace('translate-x-full', 'translate-x-0'), 100);
            setTimeout(() => {
                toast.classList.replace('translate-x-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        };

        const applyTheme = (theme) => {
            const isDarkMode = theme === 'dark-mode';
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('theme', theme);
            if (themeSunIcon && themeMoonIcon) {
                themeSunIcon.classList.toggle('hidden', isDarkMode);
                themeMoonIcon.classList.toggle('hidden', !isDarkMode);
            }
        };

        const showDashboard = () => {
            if(loginScreen) loginScreen.classList.add('hidden');
            if(dashboardContainer) dashboardContainer.classList.remove('hidden');
        };

        const showLogin = () => {
            if(dashboardContainer) dashboardContainer.classList.add('hidden');
            if(loginScreen) loginScreen.classList.remove('hidden');
            if(loginForm) loginForm.reset();
            if(loginMessage) loginMessage.textContent = '';
        };

        const loadUsers = async () => {
            if (session.role === 'team_lead' && assignedToSelect) {
                try {
                    const { data: users, error } = await supabase.from('users').select('id, name').eq('team_id', session.teamId);
                    if (error) throw error;
                    assignedToSelect.innerHTML = '<option value="" disabled selected>Assign To</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        assignedToSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading users:', error);
                    showToast('Failed to load users for task assignment.', 'error');
                }
            }
        };
        
        const loadTasks = async (view = 'all') => {
            try {
                let query = supabase.from('tasks').select('*,users(name)').eq('team_id', session.teamId);
                if (view === 'my') {
                    query = query.eq('assigned_to', session.userId);
                }
                const { data: tasks, error } = await query.order('created_at', { ascending: false });
                if (error) throw error;
                renderTasks(tasks);
            } catch (error) {
                console.error('Error loading tasks:', error);
                showToast('Failed to load tasks.', 'error');
            }
        };
        
        const renderTasks = (tasks) => {
            if (!taskTableBody) return;
            taskTableBody.innerHTML = ''; 
            const renderPriorityStars = (priority) => {
                let stars = '';
                const starCount = { 'Low': 1, 'Medium': 2, 'High': 3, 'Critical': 4 };
                const count = starCount[priority] || 0;
                for (let i = 0; i < 5; i++) {
                    stars += `<i class="fas fa-star ${i < count ? 'text-yellow-400' : 'text-gray-300 dark:text-gray-600'}"></i>`;
                }
                return `<div class="flex items-center space-x-1">${stars}</div>`;
            };
            if (tasks.length === 0) {
                taskTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-10">No tasks found.</td></tr>`;
                return;
            }
            tasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer';
                row.setAttribute('data-task-id', task.id);
                const statusClass = `status-badge-${task.status.replace(/\s/g, '-').toLowerCase()}`;
                row.innerHTML = `
                    <td class="font-semibold text-gray-800 dark:text-gray-200">${task.title}</td>
                    <td>${new Date(task.due_date).toLocaleDateString()}</td>
                    <td><span class="status-badge ${statusClass}">${task.status}</span></td>
                    <td>${renderPriorityStars(task.priority)}</td>
                    <td>${task.users ? task.users.name : 'Unassigned'}</td>
                `;
                row.addEventListener('click', () => openTaskModal(task));
                taskTableBody.appendChild(row);
            });
        };

        const openModal = (modal, content) => {
            if (!modal) return;
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('scale-95', 'opacity-0'), 10);
        };

        const closeModal = (modal, content) => {
            if (!modal) return;
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        const openTaskModal = (task) => {
            if (!taskModal || !task) return;
            openModal(taskModal, taskModalContent);
            document.getElementById('modalTitle').textContent = task.title;
            document.getElementById('modalDescription').textContent = task.description;
            document.getElementById('modalAssignedTo').textContent = task.users ? task.users.name : 'Unassigned';
            document.getElementById('modalDueDate').textContent = new Date(task.due_date).toLocaleDateString();
            const prioritySpan = document.getElementById('modalPriority');
            prioritySpan.textContent = task.priority;
            const priorityColors = { 'Low': 'bg-green-500', 'Medium': 'bg-yellow-500', 'High': 'bg-red-500', 'Critical': 'bg-red-700' };
            prioritySpan.className = `font-medium px-2 py-1 rounded-full text-xs text-white ${priorityColors[task.priority]}`;
            const statusSelect = document.getElementById('modalStatus');
            statusSelect.value = task.status;
            const updateButton = updateTaskForm.querySelector('button');
            if (session.role === 'employee' && task.assigned_to !== session.userId) {
                statusSelect.disabled = true;
                updateButton.disabled = true;
                updateButton.textContent = 'Not assigned to you';
                updateButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                statusSelect.disabled = false;
                updateButton.disabled = false;
                updateButton.textContent = 'Save Changes';
                updateButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            updateTaskForm.setAttribute('data-task-id', task.id);
        };
        
        const setupRealtimeSubscriptions = () => {
            // Task Subscription
            supabase.channel('public:tasks').on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, () => loadTasks(currentView)).subscribe();
        };

        const loadDashboard = async () => {
            const sessionData = JSON.parse(localStorage.getItem('session'));
            if (!sessionData) return showLogin();
            session = sessionData;
            if (userNameDisplay) userNameDisplay.textContent = session.userName;
            if (session.role === 'team_lead') {
                createNewTaskBtnContainer.classList.remove('hidden');
                await loadUsers(); 
            } else {
                createNewTaskBtnContainer.classList.add('hidden');
            }
            await loadTasks(currentView);
            setupRealtimeSubscriptions();
            updateSidebarActiveState();
        };

        const updateSidebarActiveState = () => {
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            if (currentView === 'all') allItemsBtn.classList.add('active');
            else {
                myItemsBtn.classList.add('active');
                myTasksBtn.classList.add('active');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark-mode';
            applyTheme(savedTheme);
            
            logoutBtn.addEventListener('click', async () => {
                localStorage.removeItem('session');
                supabase.removeAllChannels();
                showLogin();
                showToast('Logged out successfully.', 'info');
            });

            createNewTaskBtn.addEventListener('click', () => openModal(createTaskModal, createTaskModalContent));
            closeCreateModalBtn.addEventListener('click', () => closeModal(createTaskModal, createTaskModalContent));
            createTaskModal.addEventListener('click', (e) => e.target.id === 'createTaskModal' && closeModal(createTaskModal, createTaskModalContent));

            createTaskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const task = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    assigned_to: document.getElementById('assignedTo').value,
                    priority: document.getElementById('taskPriority').value,
                    due_date: document.getElementById('taskDueDate').value,
                    status: 'To Do',
                    team_id: session.teamId,
                };
                try {
                    const { error } = await supabase.from('tasks').insert([task]);
                    if (error) throw error;
                    showToast('Task created successfully!', 'success');
                    createTaskForm.reset();
                    closeModal(createTaskModal, createTaskModalContent);
                } catch (error) {
                    console.error('Error creating task:', error);
                    showToast('Failed to create task.', 'error');
                }
            });
            
            updateTaskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const taskId = e.target.getAttribute('data-task-id');
                const newStatus = document.getElementById('modalStatus').value;
                try {
                    const { error } = await supabase.from('tasks').update({ status: newStatus }).eq('id', taskId);
                    if (error) throw error;
                    showToast('Task updated successfully!', 'success');
                    closeModal(taskModal, taskModalContent);
                } catch (error) {
                    console.error('Error updating task:', error);
                    showToast('Failed to update task.', 'error');
                }
            });
            
            closeModalBtn.addEventListener('click', () => closeModal(taskModal, taskModalContent));
            taskModal.addEventListener('click', (e) => e.target.id === 'taskModal' && closeModal(taskModal, taskModalContent));

            const setView = (view) => {
                currentView = view;
                loadTasks(currentView);
                updateSidebarActiveState();
            };
            allItemsBtn.addEventListener('click', (e) => { e.preventDefault(); setView('all'); });
            myItemsBtn.addEventListener('click', (e) => { e.preventDefault(); setView('my'); });
            myTasksBtn.addEventListener('click', (e) => { e.preventDefault(); setView('my'); });

            reportIssueBtn.addEventListener('click', () => openModal(issueModal, issueModalContent));
            closeIssueModalBtn.addEventListener('click', () => closeModal(issueModal, issueModalContent));
            issueModal.addEventListener('click', (e) => e.target.id === 'issueModal' && closeModal(issueModal, issueModalContent));

            themeToggle.addEventListener('click', () => {
                if (document.documentElement.classList.contains('dark')) {
                    openModal(themeWarningModal, themeWarningModalContent);
                } else {
                    applyTheme('dark-mode');
                }
            });

            confirmThemeChangeBtn.addEventListener('click', () => {
                applyTheme('light-mode');
                closeModal(themeWarningModal, themeWarningModalContent);
            });
            cancelThemeChangeBtn.addEventListener('click', () => closeModal(themeWarningModal, themeWarningModalContent));

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginMessage.textContent = 'Logging in...';
                try {
                    const teamIdInput = loginForm.teamId.value;
                    const username = loginForm.username.value;
                    const password = loginForm.password.value;

                    // Step 1: Validate against your custom tables
                    const { data: teamData, error: teamError } = await supabase.from('teams').select('team_id, team_name, password').eq('team_id', teamIdInput).single();
                    if (teamError || !teamData) throw new Error('Invalid Team ID.');
                    if (teamData.password !== password) throw new Error('Invalid team password.');
                    
                    const { data: userData, error: userError } = await supabase.from('users').select('id, name, role').eq('team_id', teamData.team_id).eq('name', username).single();
                    if (userError || !userData) throw new Error('Invalid username for this team.');

                    // Step 2: Set the session without Supabase Auth
                    session = { teamId: teamData.team_id, teamName: teamData.team_name, userId: userData.id, userName: userData.name, role: userData.role };
                    localStorage.setItem('session', JSON.stringify(session));

                    await loadDashboard();
                    showDashboard();
                    showToast('Login successful!', 'success');
                } catch (error) {
                    console.error('Login error:', error);
                    loginMessage.textContent = error.message;
                    showToast(error.message, 'error');
                }
            });
            
            // --- INITIAL LOAD CHECK ---
            const storedSession = localStorage.getItem('session');
            if (storedSession) {
                try {
                    session = JSON.parse(storedSession);
                    // This is a simplified session restoration. For full security, you'd re-authenticate.
                    loadDashboard().then(() => showDashboard());
                } catch (e) {
                    localStorage.removeItem('session');
                    showLogin();
                } 
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>

